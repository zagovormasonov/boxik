# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ø–Ω–¥–µ–∫—Å –≤ Supabase –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

## üéØ –ó–∞–¥–∞—á–∞:

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ Supabase –∏ **–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤**. –ï—Å–ª–∏ –æ–Ω –∑–∞–π–¥–µ—Ç –∑–∞–Ω–æ–≤–æ –≤ —Ç–æ—Ç –∂–µ –∞–∫–∫–∞—É–Ω—Ç –Ø–Ω–¥–µ–∫—Å, –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –ë–î.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ:

### 1. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `users`**

–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ø–Ω–¥–µ–∫—Å OAuth:
```sql
ALTER TABLE users ADD COLUMN provider VARCHAR(50) DEFAULT 'email';
ALTER TABLE users ADD COLUMN yandex_id VARCHAR(255);
ALTER TABLE users ADD COLUMN yandex_login VARCHAR(255);
ALTER TABLE users ADD COLUMN last_login TIMESTAMP WITH TIME ZONE;
```

### 2. **–°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**

```sql
-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è yandex_id
CREATE UNIQUE INDEX idx_users_yandex_id ON users(yandex_id) WHERE yandex_id IS NOT NULL;

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
CREATE INDEX idx_users_provider ON users(provider);
CREATE INDEX idx_users_last_login ON users(last_login DESC);
```

### 3. **–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ YandexCallback**

```typescript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º yandex_id –∏–ª–∏ email
const { data: existingUser, error: checkError } = await supabase
  .from('users')
  .select('*')
  .or(`yandex_id.eq.${realUser.yandex_id || realUser.yandex_code},email.eq.${realUser.email}`)
  .single()

if (existingUser) {
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
  await supabase
    .from('users')
    .update({
      name: realUser.name,
      avatar_url: realUser.avatar,
      last_login: new Date().toISOString(),
      updated_at: new Date().toISOString()
    })
    .eq('id', existingUser.id)
} else {
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
  await supabase
    .from('users')
    .insert({
      id: realUser.id,
      email: realUser.email,
      name: realUser.name,
      avatar_url: realUser.avatar,
      provider: 'yandex',
      yandex_id: realUser.yandex_id || realUser.yandex_code,
      yandex_login: realUser.yandex_login,
      created_at: realUser.created_at,
      last_login: new Date().toISOString()
    })
}
```

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

### **–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å:**
1. ‚úÖ –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ø–Ω–¥–µ–∫—Å API
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤ –ë–î –ø–æ `yandex_id` –∏ `email`
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
4. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
5. ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç

### **–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ —Ç–æ—Ç –∂–µ –∞–∫–∫–∞—É–Ω—Ç –Ø–Ω–¥–µ–∫—Å:**
1. ‚úÖ –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –Ø–Ω–¥–µ–∫—Å API
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤ –ë–î –ø–æ `yandex_id` –∏ `email`
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ (–∏–º—è, –∞–≤–∞—Ç–∞—Ä, last_login)
4. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
5. ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:

### **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- `yandex_id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ ID –Ø–Ω–¥–µ–∫—Å)
- `email` - —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ email)

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –¥–≤—É–º –ø–æ–ª—è–º:**
- –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ `yandex_id` (–æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
- –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ `email` (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î:

```sql
-- –ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ø–Ω–¥–µ–∫—Å
{
  "id": "yandex_12345",
  "email": "user@yandex.ru",
  "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "avatar_url": "https://avatars.yandex.net/get-yapic/12345/islands-200",
  "provider": "yandex",
  "yandex_id": "12345",
  "yandex_login": "ivan.ivanov",
  "created_at": "2025-01-07T10:00:00Z",
  "updated_at": "2025-01-07T10:00:00Z",
  "last_login": "2025-01-07T10:00:00Z"
}
```

## üöÄ –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:

### **–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ:**
```
YandexCallback: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Supabase
YandexCallback: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ Supabase
```

### **–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ:**
```
YandexCallback: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
YandexCallback: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Supabase
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞:

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç** `supabase_yandex_update.sql` –≤ Supabase
2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (`npm run dev`)
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:

- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Supabase**
- ‚úÖ **–ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π** –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ
- ‚úÖ **–û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ** –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ
- ‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è last_login** –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

–¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ø–Ω–¥–µ–∫—Å –±—É–¥–µ—Ç –∏–º–µ—Ç—å –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –≤ –ë–î, –∫–æ—Ç–æ—Ä–∞—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ!
